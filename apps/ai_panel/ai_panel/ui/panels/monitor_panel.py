# ui/panels/monitor_panel.py
from PyQt6.QtWidgets import QWidget, QVBoxLayout, QLabel, QFrame
from PyQt6.QtCore import Qt, QTimer
from PyQt6.QtGui import QFont, QPalette, QColor
import time
import logging
import socket
import subprocess
import psutil
from ui.base import BasePanel

logger = logging.getLogger(__name__)

class SystemMonitor:
    def get_cpu_usage(self) -> int:
        try:
            # Calculates usage since last call (~1 second interval from QTimer)
            cpu = psutil.cpu_percent(interval=None, percpu=False)
            return int(cpu)
        except Exception as e:
            logger.warning(f"Error getting CPU usage: {e}")
            return 0

    def get_memory_info(self) -> tuple:
        try:
            mem = psutil.virtual_memory()
            used_mb = int(mem.used / (1024**2))
            total_mb = int(mem.total / (1024**2))
            percent = int(mem.percent)
            return (used_mb, total_mb, percent)
        except Exception as e:
            logger.warning(f"Error getting memory info: {e}")
            return (0, 0, 0)

    def get_disk_info(self) -> tuple:
        try:
            disk = psutil.disk_usage('/')
            used_gb = round(disk.used / (1024**3), 1)
            total_gb = round(disk.total / (1024**3), 1)
            percent = int(disk.percent)
            return (int(used_gb), int(total_gb), percent)
        except Exception as e:
            logger.warning(f"Error getting disk info: {e}")
            return (0, 0, 0)

    def get_interface_ips(self, interface_names) -> dict:
        interface_ips = {}
        try:
            net_if_addrs = psutil.net_if_addrs()
            for interface in interface_names:
                interface_ips[interface] = None
                if interface in net_if_addrs:
                    for addr_info in net_if_addrs[interface]:
                        if addr_info.family == getattr(socket, 'AF_INET', 2):
                            ip = addr_info.address
                            if ip != '127.0.0.1':
                                interface_ips[interface] = ip
                                break
        except Exception as e:
            logger.warning(f"Error getting interface IPs using 'psutil': {e}")
        return interface_ips

    def get_time(self) -> str:
        return time.strftime("%H:%M:%S")


class MonitorPanel(BasePanel):
    MENU_CLOSED = 0
    MENU_OPEN = 1

    def __init__(self, state_manager=None):
        super().__init__()
        self.state_manager = state_manager
        self.monitor = SystemMonitor()
        self.menu_state = self.MENU_CLOSED
        self.selected_option_index = 0
        self.options = ["Close Menu", "Exit Program", "Power Off"]
        self.screen_saver_timeout = 10
        self.screen_saver_timer = None
        self.init_ui()
        self.init_timers()

    def init_ui(self):
        layout = QVBoxLayout()
        layout.setContentsMargins(3, 2, 3, 2)
        layout.setSpacing(1)

        self.time_label = QLabel("00:00:00")
        self.time_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.time_label.setFont(QFont("DejaVu Sans Mono", 11, QFont.Weight.DemiBold))
        self.time_label.setStyleSheet("color: #54a0ff;")
        layout.addWidget(self.time_label)

        line = QFrame()
        line.setFrameShape(QFrame.Shape.HLine)
        line.setStyleSheet("color: #444;")
        layout.addWidget(line)

        self.cpu_label = QLabel("CPU: --%")
        self.cpu_label.setFont(QFont("DejaVu Sans Mono", 10))
        self.cpu_label.setStyleSheet("color: #ff9800;")
        layout.addWidget(self.cpu_label)

        self.mem_label = QLabel("MEM: --M/--M")
        self.mem_label.setFont(QFont("DejaVu Sans Mono", 10))
        self.mem_label.setStyleSheet("color: #4caf50;")
        layout.addWidget(self.mem_label)

        self.disk_label = QLabel("DSK: --G/--G")
        self.disk_label.setFont(QFont("DejaVu Sans Mono", 10))
        self.disk_label.setStyleSheet("color: #ab47bc;")
        layout.addWidget(self.disk_label)

        self.usb_ip_label = QLabel("USB: --")
       ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰&ˆ'‘&‰